{"componentChunkName":"component---src-templates-{post}-tsx-content-file-path-null","path":"/blog/2024/09-22-gatsby-script-ssr/","result":{"data":{"markdownRemark":{"html":"<h2>개요</h2>\n<p>Gatsby에서 Google AdSense 코드를 삽입하려 했으나 SSR 과정에서 Gatsby Script API가 예상대로 작동하지 않는 문제가 발생했습니다. 이 글에서는 문제의 원인과 해결 과정, 그리고 Gatsby Script의 내부 구현에 대해 간단히 살펴보고자 합니다.</p>\n<h2>문제 상황</h2>\n<p>구글 애드센스를 적용하기 위해 사이트 소유권을 확인해야 했고, 다음 방법 중 하나를 선택해야 했습니다.</p>\n<ul>\n<li>애드센스 코드 스니펫 삽입</li>\n<li>Ads.txt 스니펫 삽입</li>\n<li>메타태그 삽입</li>\n</ul>\n<p>Ads.txt나 메타태그로 소유권 인증을 하더라도, 이후 광고를 정상적으로 게재하려면 결국 애드센스 코드를 추가해야 했습니다. 그래서 저는 처음부터 애드센스 코드 스니펫을 삽입하는 방법을 선택했습니다.</p>\n<p>이를 위해 <a href=\"https://www.gatsbyjs.com/docs/reference/built-in-components/gatsby-script/\">Gatsby Script API</a>를 사용했는데, 공식 문서에 Gatsby의 SSR에서 사용하는 예시가 있어 SSR에서도 사용 가능하다고 생각했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onRenderBody</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  setHeadComponents<span class=\"token punctuation\">,</span>\n  setHtmlAttributes<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> RenderBodyArgs<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token function\">setHeadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Script</span></span>\n      <span class=\"token attr-name\">async</span>\n      <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=...<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">crossOrigin</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>anonymous<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그러나 Google AdSense의 사이트 검증 과정에서 <strong>사이트를 확인할 수 없습니다</strong>라는 오류가 발생했습니다. SSR된 HTML을 확인해보니 Gatsby Script API로 삽입한 스크립트가 존재하지 않았습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d6b1060fa58763ff3c2de6dc5b550d33/205df/cannot-verify.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAChUlEQVR42n1TS08TURjll/kfXBg3bJRHsdDSSnnMoxJd6FoxCsatBlpaphjjiqK0NAFiTFyU1AIDhRI1CDOdsS3zOt77zTA8Fk7yzX199+T7zjm3RxRFSJKE5NgYXr2exebWFkrlMsrr6ygFUa5U2LpCe7TPzjc2tzA79wap8XG6z3F49AiCAB4DgxHML2TAP8dx8L/PdV0aFaWA0USCADkGAfKfLMuIRoeRyWYp0bIseJ4Ls2Nj//AEZ9oZrPNzcBjHA2zbprz80hLiowm6L4hXAAVRQt/AEBYyQYU2A2TjtrKKr8JT1Bsa7XsnHwHjG1zPr1QpFJBIJAkwbJk4lNPoj7AKM36FrmOD17CxpqL87hNqBwbc3wqM7/fRqj2D5/wNKxyJxa5zKEkiJqZE9N4bxPv5bMihx6qwWI/N0zM0f2pw/qzB3HkMQ51jgG3Ky+XyeBCNhmBXWhbRz0TJZBdD0jlPptGCdnoKTddhmB2Y+i84lolAEywpfsvpmy1zDgYjjMNA5U6nA03T0Gg0oO6pODo6QvO4CXX/EC3DRLfbDVpWQlGuAabTacRiceTyeUqsVquo1X5gT1Up9g8aqNXrNN/Z3UV1e5vyCsvLiMe5bZjKwo0Kh4bjWMz5gHqrBcMwmF006LqGbtuAzqyj0Vqnc79lBUnmwyfTMiROncBFYZNJQfZVDnzI+XO5Ksw8ettF9diC1nZpzfcvjK8wwL6hBPpGJKQmBAIllVOTMgYi0dA2/MKF1yq7Nu6+NVGq+2Z23MuX8mFZwe3eOG7dmcJIcoqJEzw9DvqQveXnMzMos3e6srKCYrFI8Xm1iNKXVRov9vg5z3sx8xKpVArTjzh/ArX8D9WvO1ksE/9GAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d6b1060fa58763ff3c2de6dc5b550d33/89b46/cannot-verify.webp 180w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/97ead/cannot-verify.webp 360w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/fb07f/cannot-verify.webp 720w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/64908/cannot-verify.webp 1080w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/ff8d7/cannot-verify.webp 1440w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/8315d/cannot-verify.webp 1730w\"\n              sizes=\"(max-width: 720px) 100vw, 720px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d6b1060fa58763ff3c2de6dc5b550d33/96042/cannot-verify.png 180w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/7a322/cannot-verify.png 360w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/16546/cannot-verify.png 720w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/6d80e/cannot-verify.png 1080w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/843f9/cannot-verify.png 1440w,\n/static/d6b1060fa58763ff3c2de6dc5b550d33/205df/cannot-verify.png 1730w\"\n            sizes=\"(max-width: 720px) 100vw, 720px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d6b1060fa58763ff3c2de6dc5b550d33/16546/cannot-verify.png\"\n            alt=\"cannot-verify.png\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2>문제 해결</h2>\n<p>이 문제는 Gatsby Script 컴포넌트를 React의 기본 <code>&#x3C;script></code>로 변경하여 해결할 수 있었습니다. 그러나 왜 Gatsby Script가 SSR에서 작동하지 않았는지 궁금했습니다.</p>\n<h2>Gatsby Script의 로드 전략</h2>\n<p>Gatsby Script는 <code>strategy</code> prop을 통해 스크립트 로드 전략을 지정할 수 있었습니다. 이 전략은 다음과 같은 세 가지가 있었습니다.</p>\n<ul>\n<li><code>post-hydrate</code>: React의 hydration 이후 스크립트를 로드합니다. (기본값)</li>\n<li><code>idle</code>: 메인 스레드가 유휴 상태일 때 스크립트를 로드합니다.</li>\n<li><code>off-main-thread</code>: Partytown 라이브러리를 통해 백그라운드 스레드에서 스크립트를 로드합니다.</li>\n</ul>\n<h2>Gatsby Script 내부 구현 분석</h2>\n<p>자세히 알아보기 위해 Gatsby Script의 내부 구현을 살펴봤습니다. <code>GatsbyScript</code>는 우리가 잘 아는 React Functional Component 형태였고, 각 전략별로 다음과 같은 특징이 있었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">GatsbyScript</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> ScriptProps<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ReactElement <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> src<span class=\"token punctuation\">,</span> strategy <span class=\"token operator\">=</span> ScriptStrategy<span class=\"token punctuation\">.</span>postHydrate <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> details<span class=\"token operator\">:</span> IInjectedScriptDetails <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>strategy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> ScriptStrategy<span class=\"token punctuation\">.</span>postHydrate<span class=\"token operator\">:</span>\n        details <span class=\"token operator\">=</span> <span class=\"token function\">injectScript</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token keyword\">case</span> ScriptStrategy<span class=\"token punctuation\">.</span>idle<span class=\"token operator\">:</span>\n        <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          details <span class=\"token operator\">=</span> <span class=\"token function\">injectScript</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token keyword\">case</span> ScriptStrategy<span class=\"token punctuation\">.</span>offMainThread<span class=\"token operator\">:</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> attributes <span class=\"token operator\">=</span> <span class=\"token function\">resolveAttributes</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n          collectedScriptsByPage<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">,</span> attributes<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// inject한 스크립트를 clean up</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">===</span> ScriptStrategy<span class=\"token punctuation\">.</span>offMainThread<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> inlineScript <span class=\"token operator\">=</span> <span class=\"token function\">resolveInlineScript</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> attributes <span class=\"token operator\">=</span> <span class=\"token function\">resolveAttributes</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">undefined</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      collectedScriptsByPage<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">,</span> attributes<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/partytown<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">...</span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span class=\"caption\">출처: <a href=\"https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby-script/src/gatsby-script.tsx\">gatsby-script.tsx</a></span></p>\n<h3>1. post-hydrate</h3>\n<p>컴포넌트의 리턴값은 <code>null</code>이었습니다. 대신 <code>useEffect</code> 내에서 DOM API를 사용해 스크립트를 동적으로 삽입하고 있었습니다. <code>useEffect</code>는 React의 hydration 이후에 실행되므로, 자연스럽게 스크립트는 hydration 이후에 로드됨을 확인할 수 있었습니다.</p>\n<h3>2. idle</h3>\n<p><code>post-hydrate</code> 전략과 거의 동일했지만, <code>requestIdleCallback</code> Web API를 사용해 스크립트를 삽입하고 있었습니다. 이를 통해 메인 스레드가 유휴 상태일 때 스크립트를 로드하도록 되어 있었고, 브라우저에서 해당 API를 지원하지 않는 경우 <code>setTimeout</code>으로 대체하는 폴리필 코드가 있었습니다.</p>\n<h3>3. off-main-thread</h3>\n<p>이 전략은 다른 두 방식과는 달리 <code>&#x3C;script></code>를 실제로 리턴합니다. 단, Partytown을 통해 동작하도록 <code>type=\"text/partytown\"</code> 속성을 추가하고 props를 적절히 변환하여 렌더링하고 있었습니다.</p>\n<p>또한 SSR에서 사용하기 위해</p>\n<h2>requestIdleCallback과 Partytown</h2>\n<p>이 과정에서 <code>requestIdleCallback</code>과 <strong>Partytown</strong>이라는 두 가지 새로운 키워드를 알게 되었고, 이에 대해 간단히 정리했습니다.</p>\n<h3>requestIdleCallback</h3>\n<p><a href=\"https://developer.mozilla.org/ko/docs/Web/API/Window/requestIdleCallback\"><code>requestIdleCallback</code></a>은 브라우저가 유휴 상태일 때 콜백 함수를 실행하도록 요청하는 API입니다. 이를 통해 스크립트를 메인 스레드에 부담을 주지 않고 로드할 수 있습니다.</p>\n<h3>Partytown</h3>\n<p><a href=\"https://partytown.builder.io/\">Partytown</a>은 Web Worker를 활용하여 스크립트를 백그라운드 스레드에서 로드함으로써 메인 스레드의 성능을 최적화하는 라이브러리입니다. 이 라이브러리를 활용해 스크립트를 비동기적으로 처리함으로써 페이지 로딩 속도에 영향을 최소화할 수 있습니다.</p>\n<h2>결론</h2>\n<p>구글 애드센스에서 사이트 소유권을 확인할 때처럼, SSR에서 스크립트를 삽입할 필요가 있을 경우에는 Gatsby Script API는 적절하지 않다는 것을 알게 되었습니다. <code>post-hydrate</code>, <code>idle</code> 방식은 SSR 시 <code>&#x3C;script></code> 태그를 렌더링하지 않으며, <code>off-main-thread</code> 방식은 Partytown을 사용해 스크립트를 백그라운드에서 proxy URL을 통해 로드하기 때문에 봇이 이를 제대로 감지하지 못할 가능성이 있었습니다.</p>\n<p>또한 코드 구현을 확인하는 과정에서 <code>requestIdleCallback</code>과 Partytown이라는 성능 최적화 기술을 새로 알게 되었고, 여기에 대해 좀더 깊이 알아봐야겠다는 생각을 했습니다.</p>","frontmatter":{"title":"Gatsby SSR에서 Script API 적용 이슈와 해결","date":"2024-09-22","tags":["Gatsby","Troubleshooting"],"thumbnail":null},"timeToRead":2}},"pageContext":{"id":"c82149d8-9db1-5428-b885-a99e2eddbd5f"}},"staticQueryHashes":["1147043159"],"slicesMap":{}}